<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collab Gateway Test Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c2c7;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Collab Gateway Test Client</h1>
        
        <div class="connection-controls">
            <label for="serverUrl">Server URL:</label>
            <input type="text" id="serverUrl" value="http://localhost:3000" placeholder="http://localhost:3000">
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
        </div>

        <div id="status" class="status disconnected">Disconnected</div>

        <div class="test-controls">
            <h3>Test Actions</h3>
            <button id="pingBtn" disabled>Send Ping</button>
            <input type="text" id="customMessage" placeholder="Custom message" disabled>
            <button id="customBtn" disabled>Send Custom Message</button>
        </div>

        <div class="log-section">
            <h3>Connection Log</h3>
            <button id="clearLogBtn">Clear Log</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        class CollabTestClient {
            constructor() {
                this.socket = null;
                this.isConnected = false;
                this.initializeUI();
                this.token = 'dev-test-token'; // Replace with actual JWT after
            }

            initializeUI() {
                this.serverUrlInput = document.getElementById('serverUrl');
                this.connectBtn = document.getElementById('connectBtn');
                this.disconnectBtn = document.getElementById('disconnectBtn');
                this.statusDiv = document.getElementById('status');
                this.pingBtn = document.getElementById('pingBtn');
                this.customMessageInput = document.getElementById('customMessage');
                this.customBtn = document.getElementById('customBtn');
                this.logDiv = document.getElementById('log');
                this.clearLogBtn = document.getElementById('clearLogBtn');

                this.connectBtn.addEventListener('click', () => this.connect());
                this.disconnectBtn.addEventListener('click', () => this.disconnect());
                this.pingBtn.addEventListener('click', () => this.sendPing());
                this.customBtn.addEventListener('click', () => this.sendCustomMessage());
                this.clearLogBtn.addEventListener('click', () => this.clearLog());
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}\n`;
                this.logDiv.textContent += logMessage;
                this.logDiv.scrollTop = this.logDiv.scrollHeight;
            }

            updateStatus(connected, message = '') {
                this.isConnected = connected;
                this.statusDiv.className = `status ${connected ? 'connected' : 'disconnected'}`;
                
                if (connected) {
                    this.statusDiv.textContent = `Connected ${message}`;
                    this.connectBtn.disabled = true;
                    this.disconnectBtn.disabled = false;
                    this.pingBtn.disabled = false;
                    this.customMessageInput.disabled = false;
                    this.customBtn.disabled = false;
                } else {
                    this.statusDiv.textContent = `Disconnected ${message}`;
                    this.connectBtn.disabled = false;
                    this.disconnectBtn.disabled = true;
                    this.pingBtn.disabled = true;
                    this.customMessageInput.disabled = true;
                    this.customBtn.disabled = true;
                }
            }

            connect() {
                const serverUrl = this.serverUrlInput.value;
                this.log(`Attempting to connect to ${serverUrl}/collab`);

                try {
                    this.socket = io(`${serverUrl}/collab`, {
                        transports: ['websocket'],
                        auth: {
                            token: this.token // Replace with actual JWT if needed
                        },
                        forceNew: true
                    });

                    this.socket.on('connect', () => {
                        this.log(`Connected with socket ID: ${this.socket.id}`);
                        this.updateStatus(true, `(ID: ${this.socket.id})`);
                    });

                    this.socket.on('disconnect', (reason) => {
                        this.log(`Disconnected. Reason: ${reason}`);
                        this.updateStatus(false, `(${reason})`);
                    });

                    this.socket.on('connect_error', (error) => {
                        this.log(`Connection error: ${error.message}`);
                        this.updateStatus(false, '- Connection Error');
                    });

                    // Listen for pong responses
                    this.socket.on('pong', (data) => {
                        this.log(`Received pong: ${JSON.stringify(data)}`);
                    });

                    // Listen for any other events
                    this.socket.onAny((eventName, ...args) => {
                        if (eventName !== 'pong') { // Don't log pong twice
                            this.log(`Received event '${eventName}': ${JSON.stringify(args)}`);
                        }
                    });

                } catch (error) {
                    this.log(`Error creating socket: ${error.message}`);
                    this.updateStatus(false, '- Error');
                }
            }

            disconnect() {
                if (this.socket) {
                    this.socket.disconnect();
                    this.socket = null;
                }
                this.updateStatus(false);
            }

            sendPing() {
                if (this.socket && this.isConnected) {
                    const pingData = { 
                        timestamp: Date.now(), 
                        message: 'Test ping from web client' 
                    };
                    this.log(`Sending ping: ${JSON.stringify(pingData)}`);
                    this.socket.emit('ping', pingData);
                } else {
                    this.log('Cannot send ping - not connected');
                }
            }

            sendCustomMessage() {
                if (this.socket && this.isConnected) {
                    const message = this.customMessageInput.value.trim();
                    if (message) {
                        const customData = {
                            type: 'custom',
                            message: message,
                            timestamp: Date.now()
                        };
                        this.log(`Sending custom message 'ping': ${JSON.stringify(customData)}`);
                        this.socket.emit('ping', customData);
                        this.customMessageInput.value = '';
                    }
                } else {
                    this.log('Cannot send message - not connected');
                }
            }

            clearLog() {
                this.logDiv.textContent = '';
            }
        }

        // Initialize the test client when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new CollabTestClient();
        });
    </script>
</body>
</html>